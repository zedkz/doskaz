version: "3.4"

services:
  backend:
    build:
      context: ../backend
      dockerfile: docker/Dockerfile
    environment:
      - FIREBASE_API_KEY
      - DATABASE_URL=pgsql://postgres:${DB_PASSWORD}@database:5432/${DB_NAME}
      - OAUTH_GOOGLE_CLIENT_ID
      - OAUTH_GOOGLE_CLIENT_SECRET
      - OAUTH_GOOGLE_REDIRECT_URI
      - PHP_DATE_TIMEZONE=Asia/Almaty
    volumes:
      - doskaz_storage:/app/public/storage
      - doskaz_storage:/app/storage
    networks:
      - default
      - web
    labels:
      - traefik.enable=true
      - traefik.http.routers.doskaz_app.rule=Host(`${APP_HOST}`) && PathPrefix(`/api`, `/storage`, `/static`)
      - traefik.http.middlewares.doskaz_compress_app.compress=true
      - traefik.http.routers.doskaz_app.middlewares=doskaz_compress_app
      - traefik.http.routers.app_rss.rule=Host(`${APP_HOST}`) && Path(`/blog/rss`)
      - traefik.http.middlewares.rss_replace.replacepath.path=/api/blogPosts/rss
      - traefik.http.routers.app_rss.middlewares=rss_replace
    depends_on:
      - database

  frontend:
    build:
      context: ../frontend
      dockerfile: Dockerfile
      args:
        firebase_api_key: ${FIREBASE_API_KEY}
    labels:
      - traefik.enable=true
      - traefik.http.routers.doskaz_frontend.rule=Host(`${APP_HOST}`)
      - traefik.http.middlewares.doskaz_compress_frontend.compress=true
      - traefik.http.routers.doskaz_frontend.middlewares=doskaz_compress_frontend
      - traefik.port=3000
    networks:
      - web
    environment:
      - BACKEND_DOMAIN=http://backend
      - NUXT_HOST=0.0.0.0
    depends_on:
      - backend

  adminpanel:
    build:
      context: ../adminpanel
      dockerfile: Dockerfile
    networks:
      - web
    labels:
      - traefik.enable=true
      - traefik.http.routers.doskaz_adminpanel.rule=Host(`${APP_HOST}`) && PathPrefix(`/adminpanel`)
      - traefik.http.middlewares.stripprefix.stripprefix.prefixes=/adminpanel
      - traefik.http.routers.doskaz_adminpanel.middlewares=doskaz_compress_frontend,stripprefix
    depends_on:
      - backend

  database:
    image: mdillon/postgis:11
    environment:
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_DB: ${DB_NAME}
    volumes:
      - doskaz_db:/var/lib/postgresql/data

  imgproxy:
    image: darthsim/imgproxy:v2.10
    environment:
      - IMGPROXY_LOCAL_FILESYSTEM_ROOT=/mnt/data
      - IMGPROXY_JPEG_PROGRESSIVE=true
      - IMGPROXY_ENABLE_WEBP_DETECTION=true
      - IMGPROXY_ENFORCE_WEBP=true
    volumes:
      - doskaz_storage:/mnt/data/storage
    networks:
      - web
    labels:
      - traefik.enable=true
      - traefik.port=8080
      - traefik.docker.network=web
      - traefik.http.routers.doskaz_imgproxy.rule=Host(`${APP_HOST}`) && PathPrefix(`/img`)
      - traefik.http.middlewares.doskaz_imgproxy.stripprefix.prefixes=/img
      - traefik.http.routers.doskaz_imgproxy.middlewares=doskaz_imgproxy

  gotenberg:
    image: thecodingmachine/gotenberg:6

volumes:
  doskaz_db:
    external: true
  doskaz_storage:
    external: true

networks:
  web:
    external: true